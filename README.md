Чистым кодом тут пока  не пахнет, но я потрачу время на рефакторинг и тогда все будет выглядеть несколько лучше.
